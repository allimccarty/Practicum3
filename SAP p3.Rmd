---
title: "SAP P3"
author: "jmajoros"
date: "4/12/2021"
output: pdf_document
---

# Intoduction

The Island of Isle Royale in Lake Superior is a United States National Park located north of the state of Michigan's Upper Peninsula. These islands are home to only 19 mammals (https://www.nps.gov/isro/learn/nature/index.htm). One notable species is the otter. While the population of North American river otters are deemed of Least Concern (Population Stable), it remains important to observe and understand the mammals to ensure their conservation. Our team has been tasked to analyze cyclical, environmental, and environmental elements that impact the otters' behaviors and activity. This analysis will aid in preserving the precious species in the islands, as to understand the otters is to in turn help them. 

As we all know, climate change is a serious issue that has impacted the world and natural ecosystems heavily. A significant cause is human interference with ecosystems and natural resources. On the Island of Isle Royale, a luxury dog spa recently opened. Spas hold many issues of unstustainability, with environmental concerns from deforestation, plastic waste, and water contamination and consumption. Otters may be really sensitive to this recent introduction in their environment as fresh water has been drawn into the spa from local bodies of water. Our analysis will observe the effects of the introduction of the new luxury spa, and attempt to understand it's impact on the otters and surrounding ecosystem. 


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message=FALSE)
library(readxl)
library(tidyverse)
library(dplyr)
library(pastecs)
library(data.table)
library(formattable)
library(tidyr)
library(mice)
library(tibble)
library(GGally)
library(kableExtra)
library(ggpubr)
library(zoo)


# Read in Data
otter <- read.csv("~/Documents/IU-2020-2021/Spring-2021/Consulting/Practicum3/otter2.csv")

#Check for NA's
sum(apply(otter, 1, function(x){any(is.na(x))})) #84/100 observations have at least one missing value
sum(is.na(otter$Otter)) # NONE
sum(is.na(otter$Activity)) #NONE
sum(is.na(otter$Altitude)) #18 MISSING VALUES
sum(is.na(otter$Trout)) #16 MISSING VALUES
sum(is.na(otter$Site)) #NONE
sum(is.na(otter$Month)) #NONE
sum(is.na(otter$Lat.)) #NONE
sum(is.na(otter$Long.)) # NONE
sum(is.na(otter$Caloric)) #NONE
sum(is.na(otter$Water.Excess)) #NONE
sum(is.na(otter$Amoeba)) #40 MISSING VALUES
sum(is.na(otter$Land)) #NONE
sum(is.na(otter$Water)) #40 MISSING VALUES
sum(is.na(otter$Month.1)) #NONE
sum(is.na(otter$Year)) #NONE

#Relationship between Water and Amoeba
all.equal(is.na(otter$Water), is.na(otter$Amoeba)) # 80 element mismatches?

#Some Cleaning

numericColumns = c(2, 3, 4, 6, 9, 10, 11, 12, 13, 14, 15)
categoricalColumns = c(1, 5)
df_colnames = colnames(otter)

transpose_df <- function(df) {
  t_df <- data.table::transpose(df)
  colnames(t_df) <- rownames(df)
  rownames(t_df) <- colnames(df)
  t_df <- t_df %>%
    tibble::rownames_to_column(.data = .) %>%
    tibble::as_tibble(.)
  return(t_df)
}
```


```{r}
#Data Dictionary
library(readxl)
library(kableExtra)
library(gridExtra)
data_dict = read_excel("Data_dictionary.xlsx")
data_dict %>%
kbl(caption = "Data Dictionary", label = "Table 1") %>% kable_paper("hover", full_width = F) %>% kable_styling(full_width = TRUE)

```

# The Data

The data for the analysis were obtained by International Hugs for Otters (IHO).  The data was collected over the period from July 2018 to February 2020 on five  river  otters  (RO-599,  RO-106, RO-255, RO-918, RO-859) located in five distinct regions on the Island of Isle Royale in Lake Superior, north of the state of Michigan’s upper peninsula.  Each observation is aggregated to represent otter/region  characteristics  each  month.  The data contains 100 observations of 15 variables.  Additionally, the data is proprietary, and many of the variables have been standardized due to privacy concerns.  Description of all variables can be found in the data dictionary of the appendix.

The data obtained by IHO contains 100 observations on 15 variables. The data contained two categorical variables representing site and otter. These are directly related, as data were only gathered on one otter species per site.  Additionally, there are 20 total observations per site, representing variables obtained in a particular month of the 20 month study. From the data, 84 (84%) observations that contain one or more missing values for one or multiple of the following variables:  Altitude, Trout, Amoeba, Water.  However, two of the variables with missing observations, Amoeba and Water, are not applicable to some sites, and are therefore marked as "N/A", causing an artifically high censorship rate.  Since there is a systemic cause for missingness in these two variables, we will address observations that have missing values using different methodologies.

#### Examination of Missing Data

The variables representing altitude and trout had 18 and 16 "N/A" observations, respectively. As the data is aggregated to represent scaled measurements over certain months, we wanted to address missing observations such that seasonal patterns and trends are observed. Therefore, we used an interpolation method to correct the missing data in the set for these two variables. Observations with "N/A" for either of these variables were replaced with the by taking the average value of the month prior and the month after for that specific variable. 

The variables representing amoeba and water both had 40 "N/A" observations, meaning that these variables were not applicable to two of the five sites each.  The amoeba variable, which represents green mussel amoeba in the green mussels, was not applicable to the Gamma and Delta site, due to lack of green mussels in these regions.  The water variable was not applicable to the Omega or Alpha site due to the fact that otters in these sites are coastal otters. To adjust for missingness in these variables, we created new dummy variables with binary values to represent if the value for amoeba or water was missing (1) for that specific observation or not (0).  Next, we performed a linear transformation of +1 to the amoeba variable such that the adjusted scale was strictly positive (ranging from 0-2).  Finally, we performed a single variable imputation for the amoeba and water variables, where we replaced "N/A" values with 0 if those variables were not applicable to the site.

The final data set contains 100 total observations of 17 variables with 0 missing values. From  this  data  set  we have compiled descriptive statistics into Table 1.


```{r}
# Missingness Patter Plot
#Did I do this right?
#plot = mice::md.pattern(otter %>% select(3, 4, 11, 13),plot = TRUE,rotate.names = TRUE)
#View(plot)
```

## Data Interpolation, Imputation, and Transformation for Missing Values


#### Data Interpolation ofor Altitute and Trout

The variables representing altitude and trout had 18 and 16 "N/A" observations, respectively. These variables represent the average change in altitude and amount of trout present over the month of observation.  Due to the time series nature of the data, we used an interpolation method to correct the missing data in the set.  Observations with "N/A" for either of these variables were replaced with the average of the measurement for that value for the month prior and after that specific observation.  

```{r}
otter <- otter %>%
  group_by(Site) %>%
  mutate(Alt.Interp = na.approx(Altitude, na.rm=FALSE))   

otter <- otter %>%
  group_by(Site) %>%
  mutate(Trout.Interp = na.approx(Trout, na.rm=FALSE)) 
```

#### Transformation and Imputation of Ameoba and Water Variable

The variables representing amoeba and water both had 40 "N/A" observations, meaning that these variables were not applicable to two of the five sites each.  The amoeba variable, which represents green mussel amoeba in the green mussels, was not applicable to the Gamma and Delta site, due to lack of green mussels in these regions.  The water variable was not applicable to the Omega or Alpha site due to the fact that otters in these sites are coastal otters.  

Both variables for Ameoba and Water represent scaled measures rather than pure measurements.  The amoeba scale ranged from -1 to 1, while the water scale was strictly negative, with a minimal value of -27.4014.  To adjust for missingness in these variables, we created new dummy variables with binary values to represent if the value for amoeba or water was missing (1) for that specific observation or not (0).  Next, we performed a linear transformation of +1 to the amoeba variable such that the adjusted scale ranged from 0 to 2.  Finally, we performed a single variable imputation for the amoeba and water variables, where we replaced "N/A" values with 0 if those variables were not applicable to the site.

```{r}
#Add dummy variable representing if the value was missing (1) or not (0)
otter$AmoebaNA <- ifelse(is.na(otter$Amoeba), 1, 0)
otter$WaterNA <- ifelse(is.na(otter$Water), 1, 0)

#Transformation on Amoeba
otter$Amoeba <- otter$Amoeba +1

# Imputation on Amoeba and Water
otter = otter %>%
  mutate(
    Amoeba = replace_na(Amoeba,0),
    Water = replace_na(Water,0)
  )
```

## Descriptive Statistics

```{r}
interest.vars <- c("Activity", "Caloric", "Water.Excess", "Amoeba", "Land", "Water")
descriptives.df <- stat.desc(otter[(interest.vars)], basic = F)
descriptives.df <- descriptives.df[-c(3, 4, 7),]

descriptives.df %>%
kbl(caption = "Descriptive Statistics for Quantitative Variables", label = "Table 2") %>% kable_paper("hover", full_width = F)
```

\newpage

# Specific Aims

SA1: To understand otter activity under different factors and conditions \
1.1: Gather descriptive statistics of all variables measuring cyclic, seasonal, and environmental factors, shared conditions, and outcome \
1.2: Obtain 2- and 3- variable comparisons describing the associations between factors, conditions, and outcome (activity) \
  1.2.1: Highlight potential group patterns of interest \
  1.2.2: Identify cross sectional and longitudinal patterns \
1.3: Evaluate data missingness as it relates to site location \


SA2: To determine the factors that impact each otter’s activity level, taking into account the shared ecology, resources, and encounters. \
2.1 Use hierarchical models to do longitudinal modeling of change in otter activity level from the period July 2018 through February 2020 \
    2.1.1 Fit basic linear model for activity level \
    2.1.2 Random intercept model for individual otter differences \
    2.1.3 Individual trajectory model with random slope for time \
    2.1.4 Curvilinear trajectory model with random nonlinear time \
    2.1.5 Individual trajectory model with fixed effects for otter type and different location \
2.2 OLS modeling activity before and after the opening of dog spa \